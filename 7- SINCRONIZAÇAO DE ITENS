' ============================================================
' Regra iLogic: Copiar ItemNumber da montagem pai para linhas
'              das submontagens com mesmo Part Number
' Objetivo:
'   Comparar Part Number entre pai e submontagens e copiar
'   ItemNumber correspondente para manter consistência.
' Requisitos:
'   – montagem ativa com Structured BOM All Levels
'   – permissão para salvar submontagens
' ============================================================

Sub Main()
    ' Verifica que documento ativo é montagem
    If ThisApplication.ActiveDocument Is Nothing OrElse _
       Not TypeOf ThisApplication.ActiveDocument Is AssemblyDocument Then
        MessageBox.Show("Erro: documento ativo deve ser uma montagem (Assembly).", "Erro")
        Exit Sub
    End If

    Dim asmPai As AssemblyDocument = CType(ThisApplication.ActiveDocument, AssemblyDocument)
    Dim bomPai As BOM = asmPai.ComponentDefinition.BOM

    ' Garante que structured view esteja ativado e para todos os níveis
    bomPai.StructuredViewEnabled = True
    bomPai.StructuredViewFirstLevelOnly = False

    ' Obtém view estruturada do pai
    Dim viewPai As BOMView = GetStructuredView(bomPai)
    If viewPai Is Nothing Then
        MessageBox.Show("Vista Structured BOM do pai não encontrada.", "Erro")
        Exit Sub
    End If

    ' Cria dicionário mapa de PartNumber -> ItemNumber para o pai
    Dim mapaPai As New Dictionary(Of String, String)
    For Each rowPai As BOMRow In viewPai.BOMRows
        Dim pnPai As String = GetPartNumber(rowPai)
        If pnPai IsNot Nothing Then
            mapaPai(pnPai) = rowPai.ItemNumber
        End If
    Next

    ' Processa submontagens recursivamente
    Dim arquivosProcessados As New System.Collections.Generic.HashSet(Of String)
    CopiarItemNumberParaSubmontagens(asmPai, mapaPai, arquivosProcessados)

    ' Salvar montagem pai (se desejar)
    Try
        asmPai.Save()
    Catch ex As Exception
        MessageBox.Show("Erro ao salvar montagem pai: " & asmPai.FullFileName & vbCrLf & ex.Message, "Erro Salvamento")
    End Try

    MessageBox.Show("ItemNumber copiado para submontagens com base no Part Number.", "Conclusão")
End Sub

' --------------------------------------------------------
' Função recursiva para copiar ItemNumber para submontagens
Sub CopiarItemNumberParaSubmontagens(asmAtual As AssemblyDocument, mapaPai As Dictionary(Of String, String), processed As System.Collections.Generic.HashSet(Of String))
    Dim bomAtual As BOM = asmAtual.ComponentDefinition.BOM
    bomAtual.StructuredViewEnabled = True
    bomAtual.StructuredViewFirstLevelOnly = False

    Dim viewAtual As BOMView = GetStructuredView(bomAtual)
    If viewAtual Is Nothing Then Exit Sub

    For Each rowPai As BOMRow In viewAtual.BOMRows
        If rowPai.ChildRows IsNot Nothing Then
            Dim docSub As Document = Nothing
            Try
                docSub = rowPai.ComponentDefinitions(1).Document
            Catch
                Continue For
            End Try

            If TypeOf docSub Is AssemblyDocument Then
                Dim asmSub As AssemblyDocument = CType(docSub, AssemblyDocument)
                Dim caminhoSub As String = asmSub.FullFileName

                If Not processed.Contains(caminhoSub) Then
                    processed.Add(caminhoSub)

                    ' Prepara submontagem
                    Dim bomSub As BOM = asmSub.ComponentDefinition.BOM
                    bomSub.StructuredViewEnabled = True
                    bomSub.StructuredViewFirstLevelOnly = False

                    Dim viewSub As BOMView = GetStructuredView(bomSub)
                    If viewSub IsNot Nothing Then
                        ' Para cada linha da submontagem
                        For Each rowSub As BOMRow In viewSub.BOMRows
                            Dim pnSub As String = GetPartNumber(rowSub)
                            If pnSub IsNot Nothing AndAlso mapaPai.ContainsKey(pnSub) Then
                                ' Copiar ItemNumber do pai
                                rowSub.ItemNumber = mapaPai(pnSub)
                            End If

                            ' Recursão para níveis abaixo
                            If rowSub.ChildRows IsNot Nothing Then
                                ' Construir novo mapa para este nível, se quiser que a correspondência continue do nível pai
                                ' Aqui estamos usando sempre o mapaPai original, mas poderia se atualizar para mapa local
                                CopiarItemNumberParaSubmontagens(asmSub, mapaPai, processed)
                            End If
                        Next

                        ' Salvar submontagem modificada
                        Try
                            asmSub.Save()
                        Catch ex As Exception
                            MessageBox.Show("Erro ao salvar submontagem: " & asmSub.FullFileName & vbCrLf & ex.Message, "Erro Submontagem")
                        End Try
                    End If
                End If
            End If
        End If
    Next
End Sub

' --------------------------------------------------------
' Obtém Part Number de uma linha de BOMRow
Function GetPartNumber(r As BOMRow) As String
    Dim pn As String = Nothing
    Try
        pn = r.ComponentDefinitions(1).PropertySets("Design Tracking Properties").Item("Part Number").Value
    Catch
        ' fallback, se não existir
        pn = Nothing
    End Try
    Return pn
End Function

' --------------------------------------------------------
' Obter vista estruturada (Structured) de uma BOM
Function GetStructuredView(bom As BOM) As BOMView
    For Each v As BOMView In bom.BOMViews
        If v.ViewType = BOMViewTypeEnum.kStructuredBOMViewType Then
            Return v
        End If
    Next
    Return Nothing
End Function
